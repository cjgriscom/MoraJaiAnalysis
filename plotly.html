<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depth vs States Plotter</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        #plot {
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h1 class="card-title mb-0">Depth vs States Plotter</h1>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="btn-group flex-wrap" role="group" aria-label="File loading buttons">
                                    <button type="button" class="btn btn-success load-btn" onclick="loadFile('depths__C_WH_C_WH_C_WH_C_WH.txt')">
                                        White
                                    </button>
									<button type="button" class="btn btn-success load-btn" onclick="loadFile('depths__C_GY_C_GY_C_GY_C_GY.txt')">
										Grey
									</button>
									<button type="button" class="btn btn-success load-btn" onclick="loadFile('depths__C_PI_C_PI_C_PI_C_PI.txt')">
										Pink
									</button>
									<button type="button" class="btn btn-success load-btn" onclick="loadFile('depths__C_BK_C_BK_C_BK_C_BK.txt')">
										Black
									</button>
									<button type="button" class="btn btn-success load-btn" onclick="loadFile('depths__C_BU_C_BU_C_BU_C_BU.txt')">
										Blue
									</button>
									<button type="button" class="btn btn-success load-btn" onclick="loadFile('depths__C_RD_C_RD_C_RD_C_RD.txt')">
										Red
									</button>
									<button type="button" class="btn btn-success load-btn" onclick="loadFile('depths__C_OR_C_OR_C_OR_C_OR.txt')">
										Orange
									</button>
                                    <button type="button" class="btn btn-success load-btn" onclick="loadFile('depths__C_YE_C_YE_C_YE_C_YE.txt')">
                                        Yellow
                                    </button>
                                    <button type="button" class="btn btn-success load-btn" onclick="loadFile('depths__C_PU_C_PU_C_PU_C_PU.txt')">
                                        Purple
                                    </button>
                                    <button type="button" class="btn btn-success load-btn" onclick="loadFile('depths__C_GN_C_GN_C_GN_C_GN.txt')">
                                        Green
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="clearPlot()">
                                        Clear Plot
                                    </button>
                                    <button type="button" class="btn btn-info ms-2" onclick="exportToJSON()">
                                        Export JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div id="plot"></div>
                            </div>
                        </div>
                        
                        <div id="info" class="alert alert-info mt-3" style="display: none;">
                            <strong>File Info:</strong> <span id="file-stats"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JSON Export Modal -->
    <div class="modal fade" id="jsonModal" tabindex="-1" aria-labelledby="jsonModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="jsonModalLabel">Exported Data (JSON)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <small class="text-muted">You can copy the JSON data below:</small>
                        <button type="button" class="btn btn-sm btn-outline-secondary float-end" onclick="copyToClipboard()">
                            Copy to Clipboard
                        </button>
                    </div>
                    <pre id="jsonOutput" class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let plotData = [];
        let currentColors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b'];
        let colorIndex = 0;

        async function loadFile(filename) {
            const infoDiv = document.getElementById('info');
            const fileStats = document.getElementById('file-stats');
            
            try {
                // Disable all buttons while loading
                const buttons = document.querySelectorAll('.load-btn');
                buttons.forEach(btn => btn.disabled = true);
                
                // Show loading message
                infoDiv.style.display = 'block';
                infoDiv.className = 'alert alert-info mt-3';
                fileStats.textContent = `Loading ${filename}...`;
                
                // Fetch the file
                const response = await fetch(filename + '?v=' + new Date().getTime());
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                
                // Parse the file content
                const { depths, states } = parseFileContent(text);
                
                if (depths.length === 0) {
                    throw new Error('No valid depth data found in file');
                }
                
                // Create plot trace
                const trace = {
                    x: depths,
                    y: states,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: filename.replace('depths__', '').replace('.txt', ''),
                    line: {
                        color: currentColors[colorIndex % currentColors.length],
                        width: 2
                    },
                    marker: {
                        size: 6,
                        color: currentColors[colorIndex % currentColors.length]
                    }
                };
                
                // Add annotation for the last point
                const lastDepth = depths[depths.length - 1];
                const lastStates = states[states.length - 1];
                
                const annotation = {
                    x: lastDepth,
                    y: Math.log10(lastStates),
                    text: `Depth ${lastDepth}: ${lastStates} states`,
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: currentColors[colorIndex % currentColors.length],
                    ax: -60,
                    ay: -30,
                    bgcolor: 'rgba(255, 255, 0, 0.8)',
                    bordercolor: currentColors[colorIndex % currentColors.length],
                    borderwidth: 1
                };
                
                plotData.push(trace);
                colorIndex++;
                
                // Update the plot
                const layout = {
                    title: {
                        text: 'Depth vs Number of States (Logarithmic Scale)',
                        font: { size: 16 }
                    },
                    xaxis: {
                        title: 'Depth',
                        gridcolor: 'rgba(0,0,0,0.1)'
                    },
                    yaxis: {
                        title: 'Number of States',
                        type: 'log',
                        gridcolor: 'rgba(0,0,0,0.1)'
                    },
                    plot_bgcolor: 'white',
                    annotations: []
                };
                
                Plotly.newPlot('plot', plotData, layout, {responsive: true});
                
                // Update info
                const minStates = Math.min(...states);
                const maxStates = Math.max(...states);
                const minDepth = Math.min(...depths);
                const maxDepth = Math.max(...depths);
                
                // Update info with success styling
                infoDiv.className = 'alert alert-success mt-3';
                fileStats.textContent = `${filename} loaded successfully. Found ${depths.length} depth entries. Depth range: ${minDepth}-${maxDepth}, States range: ${minStates.toLocaleString()}-${maxStates.toLocaleString()}`;
                
            } catch (error) {
                console.error('Error loading file:', error);
                infoDiv.className = 'alert alert-danger mt-3';
                fileStats.textContent = `Error loading ${filename}: ${error.message}`;
            } finally {
                // Re-enable buttons
                const buttons = document.querySelectorAll('.load-btn');
                buttons.forEach(btn => btn.disabled = false);
            }
        }
        
        function parseFileContent(text) {
            const depths = [];
            const states = [];
            const lines = text.split('\n');
            
            for (const line of lines) {
                // Look for lines matching the pattern "Depth X has Y states"
                const match = line.trim().match(/^Depth (\d+) has (\d+) states$/);
                if (match) {
                    const depth = parseInt(match[1]);
                    const stateCount = parseInt(match[2]);
                    depths.push(depth);
                    states.push(stateCount);
                }
            }
            
            return { depths, states };
        }
        
        function clearPlot() {
            plotData = [];
            colorIndex = 0;
            Plotly.newPlot('plot', [], {
                title: {
                    text: 'Depth vs Number of States (Logarithmic Scale)',
                    font: { size: 16 }
                },
                xaxis: {
                    title: 'Depth',
                    gridcolor: 'rgba(0,0,0,0.1)'
                },
                yaxis: {
                    title: 'Number of States',
                    type: 'log',
                    gridcolor: 'rgba(0,0,0,0.1)'
                },
                plot_bgcolor: 'white'
            }, {responsive: true});
            
            const infoDiv = document.getElementById('info');
            infoDiv.style.display = 'none';
        }
        
        function exportToJSON() {
            if (plotData.length === 0) {
                alert('No data to export. Please load some files first.');
                return;
            }
            
            // Format the data for export
            const exportData = {
                timestamp: new Date().toISOString(),
                datasetCount: plotData.length,
                datasets: plotData.map(trace => ({
                    name: trace.name,
                    dataPoints: trace.x.length,
                    depthRange: {
                        min: Math.min(...trace.x),
                        max: Math.max(...trace.x)
                    },
                    stateRange: {
                        min: Math.min(...trace.y),
                        max: Math.max(...trace.y)
                    },
                    data: trace.x.map((depth, index) => ({
                        depth: depth,
                        states: trace.y[index]
                    }))
                }))
            };
            
            // Pretty print the JSON
            const jsonString = JSON.stringify(exportData, null, 2);
            
            // Display in modal
            document.getElementById('jsonOutput').textContent = jsonString;
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('jsonModal'));
            modal.show();
            
            // Also log to console for developer access
            console.log('Exported data:', exportData);
        }
        
        function copyToClipboard() {
            const jsonOutput = document.getElementById('jsonOutput');
            const textArea = document.createElement('textarea');
            textArea.value = jsonOutput.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // Show feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 2000);
        }
        
        // Initialize empty plot
        window.onload = function() {
            clearPlot();
        };
    </script>
</body>
</html>